<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Buscador avanzado de BIN</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #d0d2e0;
      --text: #1f2933;
      --muted: #52636d;
      --accent: #2563eb;
      --shadow: 0 10px 35px rgba(31, 41, 51, 0.1);
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    header {
      padding: 2.5rem 1.5rem 2rem;
      text-align: center;
      background: linear-gradient(120deg, #111827, #1e3a8a);
      color: #fff;
      box-shadow: var(--shadow);
    }
    header h1 {
      margin: 0 0 0.5rem;
      font-size: 2.2rem;
      letter-spacing: -0.02em;
    }
    header p {
      margin: 0;
      color: rgba(255,255,255,0.82);
    }
    main {
      max-width: 1200px;
      margin: 0 auto 2rem;
      padding: 1.5rem 1.25rem 2rem;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 1.75rem;
      box-shadow: var(--shadow);
      position: relative;
      z-index: 1;
    }
    .filter-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      margin-bottom: 1rem;
    }

    /* Ensure input groups are positioned relative so autocomplete dropdowns anchor properly */
    .input-group {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .input-group label {
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--muted);
      font-size: 0.93rem;
    }
    .input-group input {
      padding: 0.65rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 0.95rem;
      background: #fdfdff;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
      background: #fff;
    }
    .form-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }
    button {
      padding: 0.85rem 1.6rem;
      border: none;
      border-radius: 10px;
      background: var(--accent);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.18);
    }
    button:hover {
      background: #1749b8;
      transform: translateY(-1px);
    }
    button:active {
      transform: translateY(0);
    }
    button.secondary {
      background: #111827;
      box-shadow: 0 10px 25px rgba(17, 24, 39, 0.15);
    }
    button.secondary:hover {
      background: #0b1221;
    }
    .status-bar {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 0.9rem;
      border-radius: 12px;
      background: #f0f4ff;
      color: #1d3a8a;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .results-meta {
      margin: 1rem 0;
      font-size: 0.95rem;
      color: var(--muted);
      font-weight: 600;
    }
    #exportControls {
      background: #f8fafc;
      border: 1px solid var(--border);
      padding: 0.75rem 1rem;
      border-radius: 10px;
      display: inline-flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.65rem 0.85rem;
      margin: 1rem 0;
    }
    #exportControls span {
      font-weight: 700;
      color: var(--muted);
      margin-right: 0.25rem;
    }
    #exportControls label {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-weight: 600;
    }
    #exportControls button {
      padding: 0.75rem 1.2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 0.5rem;
      font-size: 0.85rem;
      text-align: left;
    }
    th {
      background: var(--bg);
      font-weight: 600;
      letter-spacing: -0.01em;
    }
    tbody tr:nth-child(even) {
      background: #f8f9fb;
    }
    .hidden {
      display: none;
    }
    .autocomplete-suggestions {
      position: absolute;
      inset: auto 0 auto 0;
      top: 100%;
      background: #fff;
      border: 1px solid var(--border);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
      max-height: 180px;
      overflow-y: auto;
      border-radius: 10px;
      padding: 0.3rem 0;
      z-index: 20;
    }
    .autocomplete-item {
      padding: 0.55rem 0.75rem;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    .autocomplete-item:hover {
      background: rgba(37, 99, 235, 0.08);
      color: #0f172a;
    }
    @media (max-width: 720px) {
      header h1 {
        font-size: 1.85rem;
      }
      .card {
        padding: 1.25rem;
      }
      .filter-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
      button {
        width: 100%;
        justify-content: center;
      }
      .form-actions {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Buscador avanzado de BIN</h1>
    <p>Consulta BIN por múltiples filtros y autocompletado</p>
  </header>
  <main>
    <div class="card">
      <div id="loadStatus" class="status-bar">Cargando datos...</div>
      <form id="searchForm">
        <div class="filter-grid">
          <div class="input-group">
            <label for="binInput">BIN (prefix)</label>
            <input id="binInput" type="text" placeholder="Ej. 4571">
          </div>
          <div class="input-group">
            <label for="countryInput">País</label>
            <input id="countryInput" type="text" placeholder="Ej. United States">
          </div>
          <div class="input-group">
            <label for="issuerInput">Banco / Issuer</label>
            <input id="issuerInput" type="text" placeholder="Ej. JPMorgan Chase">
          </div>
          <div class="input-group">
            <label for="brandInput">Marca de tarjeta</label>
            <input id="brandInput" type="text" placeholder="Ej. Visa">
          </div>
          <div class="input-group">
            <label for="typeInput">Tipo</label>
            <input id="typeInput" type="text" placeholder="Credit, Debit, Prepaid...">
          </div>
          <div class="input-group">
            <label for="categoryInput">Categoría / Nivel</label>
            <input id="categoryInput" type="text" placeholder="Classic, Platinum...">
          </div>
          <div class="input-group">
            <label for="iso2Input">Código ISO2</label>
            <input id="iso2Input" type="text" placeholder="Ej. US" maxlength="2">
          </div>
          <div class="input-group">
            <label for="iso3Input">Código ISO3</label>
            <input id="iso3Input" type="text" placeholder="Ej. USA" maxlength="3">
          </div>
          <div class="input-group">
            <label for="phoneInput">Teléfono del banco</label>
            <input id="phoneInput" type="text" placeholder="Coincidencia parcial">
          </div>
        </div>
        <div class="form-actions">
          <button type="submit">Buscar</button>
          <button type="button" id="clearBtn" class="secondary">Limpiar</button>
        </div>
      </form>
      <div class="results-meta hidden" id="resultsMeta"></div>
      <!-- Export controls: allow users to choose which fields to include in the downloaded results -->
      <div id="exportControls" class="hidden">
        <span>Selecciona columnas para exportar:</span>
        <label><input type="checkbox" class="export-field" data-field="BIN" checked> BIN</label>
        <label><input type="checkbox" class="export-field" data-field="Brand" checked> Marca</label>
        <label><input type="checkbox" class="export-field" data-field="Type" checked> Tipo</label>
        <label><input type="checkbox" class="export-field" data-field="Category" checked> Categoría</label>
        <label><input type="checkbox" class="export-field" data-field="Issuer" checked> Banco</label>
        <label><input type="checkbox" class="export-field" data-field="IssuerPhone" checked> Teléfono</label>
        <label><input type="checkbox" class="export-field" data-field="CountryName" checked> País</label>
        <label><input type="checkbox" class="export-field" data-field="isoCode2" checked> ISO2</label>
        <label><input type="checkbox" class="export-field" data-field="isoCode3" checked> ISO3</label>
        <button id="exportButton" type="button">Descargar</button>
      </div>
      <div style="overflow-x:auto;">
        <table id="resultsTable" class="hidden">
          <thead>
            <tr>
              <th>BIN</th>
              <th>Brand</th>
              <th>Type</th>
              <th>Category</th>
              <th>Issuer</th>
              <th>Issuer Phone</th>
              <th>Country</th>
              <th>ISO2</th>
              <th>ISO3</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>
  <script>
    let dataset = [];
    // store last search results for export
    let lastResults = [];
    // Helper to parse CSV (simple, assumes no commas inside fields)
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',');
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        const values = line.split(',');
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = values[idx] || '';
        });
        data.push(row);
      }
      return data;
    }
    function normalize(str) {
      return (str || '').toString().trim().toLowerCase();
    }

    /**
     * Set up a simple autocomplete dropdown for an input element using a list of values.
     * This helper creates a suggestions container positioned under the input. It
     * filters the provided values on every input event (case-insensitive substring)
     * and displays up to 10 matches. Clicking a suggestion fills the input and
     * hides the dropdown. Suggestions are hidden when clicking outside.
     *
     * @param {string} inputId The id of the input element to attach autocomplete to
     * @param {string[]} values A list of possible values for suggestions
     */
    function addAutocomplete(inputId, values) {
      const inputEl = document.getElementById(inputId);
      // Guard: only attach if input exists and values array provided
      if (!inputEl || !Array.isArray(values)) return;
      inputEl.setAttribute('autocomplete', 'off');
      inputEl.setAttribute('spellcheck', 'false');
      // Create suggestions container
      const container = document.createElement('div');
      container.className = 'autocomplete-suggestions hidden';
      inputEl.parentElement.appendChild(container);
      const hideSuggestions = () => {
        container.classList.add('hidden');
        container.innerHTML = '';
      };
      // Filter and render suggestions
      function showSuggestions(query) {
        const q = normalize(query);
        if (!q) {
          return hideSuggestions();
        }
        container.innerHTML = '';
        // Filter values by substring match (case-insensitive)
        const matches = values.filter(val => normalize(val).includes(q)).slice(0, 10);
        if (matches.length === 0) {
          return hideSuggestions();
        }
        matches.forEach(val => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.textContent = val;
          item.addEventListener('mousedown', () => {
            inputEl.value = val;
            hideSuggestions();
          });
          container.appendChild(item);
        });
        container.classList.remove('hidden');
      }
      // Event listeners
      inputEl.addEventListener('input', () => {
        showSuggestions(inputEl.value);
      });
      inputEl.addEventListener('focus', () => {
        if (inputEl.value.trim().length === 0) {
          hideSuggestions();
        } else {
          showSuggestions(inputEl.value);
        }
      });
      inputEl.addEventListener('keydown', (evt) => {
        if (evt.key === 'Escape') hideSuggestions();
      });
      // Hide suggestions when clicking outside
      document.addEventListener('click', (evt) => {
        if (evt.target !== inputEl && !container.contains(evt.target)) {
          hideSuggestions();
        }
      });
    }
    function buildUniqueLists() {
      const sets = {
        CountryName: new Set(),
        Issuer: new Set(),
        Brand: new Set(),
        Type: new Set(),
        Category: new Set()
      };
      const clean = (val) => (val || '').toString().trim();
      dataset.forEach(row => {
        const country = clean(row.CountryName);
        const issuer = clean(row.Issuer);
        const brand = clean(row.Brand);
        const type = clean(row.Type);
        const category = clean(row.Category);
        if (country) sets.CountryName.add(country);
        if (issuer) sets.Issuer.add(issuer);
        if (brand) sets.Brand.add(brand);
        if (type) sets.Type.add(type);
        if (category) sets.Category.add(category);
      });
      const lists = {};
      Object.keys(sets).forEach(key => {
        lists[key] = Array.from(sets[key]).sort((a,b) =>
          a.localeCompare(b, 'es', { sensitivity: 'base', usage: 'sort' })
        );
      });
      return lists;
    }
    async function loadData() {
      const statusEl = document.getElementById('loadStatus');
      try {
        const resp = await fetch('bin-list-data.csv');
        const text = await resp.text();
        dataset = parseCSV(text);
        statusEl.textContent = 'Datos cargados (' + dataset.length + ' registros)';
        const lists = buildUniqueLists();
        // Attach custom autocomplete to each filter input using unique lists.
        addAutocomplete('countryInput', lists.CountryName);
        addAutocomplete('issuerInput', lists.Issuer);
        addAutocomplete('brandInput', lists.Brand);
        addAutocomplete('typeInput', lists.Type);
        addAutocomplete('categoryInput', lists.Category);
      } catch (err) {
        statusEl.textContent = 'Error al cargar datos';
        console.error(err);
      }
    }
    function searchData(event) {
      event.preventDefault();
      const bin = normalize(document.getElementById('binInput').value);
      const country = normalize(document.getElementById('countryInput').value);
      const issuer = normalize(document.getElementById('issuerInput').value);
      const brand = normalize(document.getElementById('brandInput').value);
      const type = normalize(document.getElementById('typeInput').value);
      const category = normalize(document.getElementById('categoryInput').value);
      const iso2 = normalize(document.getElementById('iso2Input').value);
      const iso3 = normalize(document.getElementById('iso3Input').value);
      const phone = normalize(document.getElementById('phoneInput').value);
      const results = [];
      for (const row of dataset) {
        if (bin && !normalize(row.BIN).startsWith(bin)) continue;
        if (country && normalize(row.CountryName) !== country) continue;
        if (issuer && normalize(row.Issuer) !== issuer) continue;
        if (brand && normalize(row.Brand) !== brand) continue;
        if (type && normalize(row.Type) !== type) continue;
        if (category && normalize(row.Category) !== category) continue;
        if (iso2 && normalize(row.isoCode2) !== iso2) continue;
        if (iso3 && normalize(row.isoCode3) !== iso3) continue;
        if (phone && !normalize(row.IssuerPhone).includes(phone)) continue;
        results.push(row);
      }
      // store full results for exporting
      lastResults = results;
      renderResults(results);
    }
    function renderResults(results) {
      const table = document.getElementById('resultsTable');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      const meta = document.getElementById('resultsMeta');
      if (results.length === 0) {
        meta.textContent = 'No se encontraron resultados.';
        meta.classList.remove('hidden');
        table.classList.add('hidden');
        // hide export controls when no results
        const exportCtrls = document.getElementById('exportControls');
        if (exportCtrls) exportCtrls.classList.add('hidden');
        return;
      }
      const MAX_RESULTS = 200;
      let displayed = results.slice(0, MAX_RESULTS);
      displayed.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.BIN || ''}</td>
          <td>${row.Brand || ''}</td>
          <td>${row.Type || ''}</td>
          <td>${row.Category || ''}</td>
          <td>${row.Issuer || ''}</td>
          <td>${row.IssuerPhone || ''}</td>
          <td>${row.CountryName || ''}</td>
          <td>${row.isoCode2 || ''}</td>
          <td>${row.isoCode3 || ''}</td>
        `;
        tbody.appendChild(tr);
      });
      meta.textContent = 'Mostrando ' + displayed.length + ' de ' + results.length + ' resultados.';
      meta.classList.remove('hidden');
      table.classList.remove('hidden');
      // show export controls when there are results
      const exportCtrls2 = document.getElementById('exportControls');
      if (exportCtrls2) exportCtrls2.classList.remove('hidden');
    }
    document.getElementById('searchForm').addEventListener('submit', searchData);
    // set up click handler for exporting selected fields
    document.getElementById('exportButton').addEventListener('click', function() {
      if (!lastResults || lastResults.length === 0) {
        alert('No hay resultados para exportar.');
        return;
      }
      const checkboxes = document.querySelectorAll('.export-field');
      const selectedFields = [];
      const headerLabels = [];
      checkboxes.forEach(cb => {
        if (cb.checked) {
          selectedFields.push(cb.dataset.field);
          headerLabels.push(cb.parentElement.textContent.trim());
        }
      });
      if (selectedFields.length === 0) {
        alert('Seleccione al menos un campo para exportar.');
        return;
      }
      const lines = [];
      // header row with labels separated by tabs
      lines.push(headerLabels.join('\t'));
      lastResults.forEach(row => {
        const values = selectedFields.map(f => row[f] || '');
        lines.push(values.join('\t'));
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const now = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, '');
      a.href = url;
      a.download = 'bin_search_' + now + '.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // agregar manejador para limpiar los filtros y resultados
    document.getElementById('clearBtn').addEventListener('click', function() {
      // resetear todos los campos del formulario
      document.getElementById('searchForm').reset();
      // vaciar resultados almacenados
      lastResults = [];
      // ocultar resultados y meta
      const meta = document.getElementById('resultsMeta');
      meta.classList.add('hidden');
      meta.textContent = '';
      const table = document.getElementById('resultsTable');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      table.classList.add('hidden');
      // ocultar controles de exportación
      const exportCtrls3 = document.getElementById('exportControls');
      if (exportCtrls3) exportCtrls3.classList.add('hidden');
    });
    loadData();
  </script>
</body>
</html>
